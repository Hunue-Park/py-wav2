# 음성 인식 엔진 설계 문서

## 개선된 모듈 구조

1. **SentenceBlockManager (sentence_block.py)**
   - 문장을 블록 단위로 분리 관리 (선형 구조)
   - 각 블록의 상태 추적 (PENDING, ACTIVE, RECOGNIZED, EVALUATED)
   - 현재 활성 블록 계산 로직

2. **ProgressTracker (progress_tracker.py)**
   - 시간 기반 진행도 관리
   - 녹음 시작 후 경과 시간에 따른 허용 인식 범위 계산
   - 넓은 인식 윈도우 지원 (현재 블록 + 이전 N개 블록)
   - 건너뛰기 방지 및 순차적 인식 제어

3. **AudioProcessor (audio_processor.py)**
   - 실시간 음성 파일 모니터링
   - 입력 오디오 스트림 생성 및 관리
   - 음성 신호 전처리 및 VAD
   - 처리할 청크 결정 로직

4. **RecognitionEngine (w2v_onnx_core.py)**
   - GOP 계산
   - 현재 문맥에 맞는 인식 후보 필터링
   - 블록별 인식 확률 계산
   - 유연한 인식 윈도우 내 최적 매칭 선택

5. **EvaluationController (eval_manager.py)**
   - 인식 결과와 블록 매핑
   - 평가 적용 시점 결정 및 점수 계산
   - 실시간 결과 이벤트 발생

6. **EngineCoordinator (recognition_v8.py)**
   - 전체 컴포넌트 조율
   - 외부 API 제공
   - 출력 결과 스트림 관리
   - 비동기 처리 관리
   - 정기적 상태 업데이트 전송

## 주요 동작 흐름

1. **초기화**
   - 문장을 선형 블록 구조로 분할
   - 모든 블록 PENDING 상태로 초기화

2. **녹음 시작**
   - 첫 블록을 ACTIVE로 설정
   - 음성 파일 모니터링 시작

3. **실시간 인식 및 평가**
   - 일정 주기(예: 0.3초)마다 음성 파일 읽어 입력 스트림 생성
   - 현재 블록 + 이전 N개 블록에 대해 인식 수행
   - 가장 높은 신뢰도 블록에 GOP 점수 계산
   - 매 주기마다 현재 상태 및 점수를 결과 스트림으로 출력

4. **진행 상태 관리**
   - 시간 경과 및 인식 결과에 따라 활성 블록 업데이트
   - 유연한 윈도우로 사용자의 실제 발화 위치 적응

## 구현 고려 사항

1. **모듈간 의존성 관리**:
   - 의존 관계 단방향 유지
   - 하위 모듈 간 독립성 보장

2. **추가 고려 모듈**:
   - `config_manager.py`: 환경설정 관리
   - `error_handler.py`: 예외 처리 전담

3. **비동기 처리 도입**:
   - 녹음과 인식 처리 병렬화
   - 이벤트 기반 아키텍처로 실시간 결과 전달

4. **캐싱 메커니즘**:
   - 자주 사용되는 데이터 캐싱

5. **확장성 고려**:
   - 모델 교체 용이한 인터페이스
   - 다국어 지원 추상화

## 테스트 케이스

### 1. 기본 입력 및 초기화 테스트
- **설명**: 문장과 음성 녹음 파일을 입력으로 엔진이 올바르게 초기화되는지 검증
- **담당 모듈**: 
  - EngineCoordinator: 입력 처리 및 초기화 조율
  - SentenceBlockManager: 문장 분할 및 블록 초기화
- **테스트 절차**:
  1. "참으로 위대한 일 들은 서서히 일어난다." 문장 입력
  2. 녹음 시작 명령 전달
  3. 초기 블록 상태 및 활성 블록 확인

### 2. 실시간 오디오 스트림 처리 테스트
- **설명**: 녹음 파일이 지속적으로 업데이트될 때 새 데이터 감지 및 처리 검증
- **담당 모듈**: 
  - AudioProcessor: 파일 모니터링 및 스트림 생성
- **테스트 절차**:
  1. 임의의 오디오 파일 생성 및 주기적 데이터 추가
  2. AudioProcessor가 0.3초마다 파일 변경 감지하는지 검증
  3. 생성된 오디오 청크가 적절한 크기와 형식인지 확인

### 3. 순차적 인식 강제 테스트
- **설명**: 첫 블록 인식 전 후속 블록 발화 시 인식 거부 검증
- **담당 모듈**: 
  - ProgressTracker: 허용 인식 범위 관리
  - RecognitionEngine: 문맥 필터링
- **테스트 절차**:
  1. "A B C D E" 텍스트로 초기화
  2. C에 해당하는 오디오 입력 시뮬레이션
  3. 인식 결과에 C가 포함되지 않는지 확인

### 4. 시간 기반 진행 테스트
- **설명**: 충분한 시간 경과 후 C를 발화할 때 인식되는지 검증
- **담당 모듈**: 
  - ProgressTracker: 시간 기반 진행도 관리
- **테스트 절차**:
  1. "A B C D E" 텍스트로 초기화
  2. 일정 시간(5초) 경과 시뮬레이션
  3. C에 해당하는 오디오 입력
  4. C가 인식되는지 확인

### 5. 활성 블록 컨텍스트 제한 테스트
- **설명**: A 블록이 활성화되었을 때 B-E 블록에 대한 평가가 수행되지 않는지 검증
- **담당 모듈**: 
  - EvaluationController: 평가 적용 시점 결정
  - SentenceBlockManager: 블록 상태 관리
- **테스트 절차**:
  1. "A B C D E" 초기화, A 블록 활성화
  2. 전체 문장 "A B C D E" 오디오 입력
  3. A만 EVALUATED 상태로 변경되고 나머지는 평가되지 않는지 확인

### 6. 넓은 인식 윈도우 테스트
- **설명**: 현재 윈도우가 C를 가리키는데 사용자가 A를 발화할 때 인식 검증
- **담당 모듈**: 
  - ProgressTracker: 넓은 인식 윈도우 관리
  - RecognitionEngine: 윈도우 내 최적 매칭 선택
- **테스트 절차**:
  1. C 블록이 현재 활성 블록으로 설정
  2. A에 해당하는 오디오 입력 (높은 신뢰도)
  3. A가 인식되고 활성 블록이 A로 재설정되는지 확인

### 7. 실시간 결과 스트림 테스트
- **설명**: 정기적으로 현재 상태와 평가 결과가 스트림으로 출력되는지 검증
- **담당 모듈**: 
  - EngineCoordinator: 결과 스트림 관리
- **테스트 절차**:
  1. 녹음 시작 후 여러 주기(0.3초) 동안 모니터링
  2. 각 주기마다 결과 스트림 이벤트 발생 확인
  3. 스트림 데이터에 현재 상태 및 점수 정보 포함 확인

### 8. GOP 계산 정확도 테스트
- **설명**: 블록별 GOP 점수가 정확히 계산되는지 검증
- **담당 모듈**: 
  - RecognitionEngine: GOP 계산
  - EvaluationController: 점수 적용
- **테스트 절차**:
  1. 기준 발음과 테스트 발음 쌍 준비 (정확한/부정확한 발음)
  2. 각 발음에 대한 GOP 계산
  3. 정확한 발음이 높은 점수, 부정확한 발음이 낮은 점수를 받는지 확인